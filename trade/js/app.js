(function(){angular.module("myApp",["ngSailsBind"]).controller("myCon",function($scope,$http){$http({method:"jsonp",url:"http://white-bolt-42-134558.apne1.nitrousbox.com:1337/user/jsonp"}).error(function(){io.socket=io.connect("http://white-bolt-42-134558.apne1.nitrousbox.com:1337/");return io.socket.on("connect",function(){io.socket.on("message",function(message){console.log("got message:");return console.log(message)});io.socket.on("customMsg",function(message){console.log(message);return swal({title:"Error!",text:"Here's my error message!",type:"error",confirmButtonText:"Cool"})});io.socket.on("offerInvite",function(message){if($scope.offerInvited){return $scope.offerInvited(message)}});io.socket.on("offerAccepted",function(message){if($scope.offerAccepted){return $scope.offerAccepted(message)}});return io.socket.request("/user/autoLogin",{},function(data){return console.log(data)})})});$scope.currencyList=[{name:"Chromatic_Orb",cName:"幻色石",cRate:1/20},{name:"Orb_of_Alteration",cName:"修改石",cRate:1/20},{name:"Jewellers_Orb",cName:"工匠石",cRate:1/10},{name:"Orb_of_Chance",cName:"機會石",cRate:1/8},{name:"Cartographers_Chisel",cName:"製圖釘",cRate:1/3},{name:"Orb_of_Fusing",cName:"鏈結石",cRate:1/2.5},{name:"Orb_of_Alchemy",cName:"點金石",cRate:1/4},{name:"Orb_of_Scouring",cName:"重鑄石",cRate:1/2},{name:"Blessed_Orb",cName:"祝福石",cRate:3},{name:"Chaos_Orb",cName:"混沌石",cRate:1},{name:"Orb_of_Regret",cName:"後悔石",cRate:1},{name:"Regal_Orb",cName:"富豪石",cRate:1},{name:"Gemcutters_Prism",cName:"寶石匠的稜鏡",cRate:2},{name:"Divine_Orb",cName:"神聖石",cRate:15},{name:"Exalted_Orb",cName:"崇高石",cRate:30},{name:"Eternal_Orb",cName:"永恆寶珠",cRate:230},{name:"Vaal_Orb",cName:"瓦爾寶珠",cRate:1},{name:"Mirror_of_Kalandra",cName:"卡蘭德的魔鏡",cRate:990},{name:"Sacrifice_at_Dusk",cName:"黃昏的奉獻碎片",cRate:991},{name:"Sacrifice_at_Dawn",cName:"黎明的奉獻碎片",cRate:992},{name:"Sacrifice_at_Noon",cName:"正午的奉獻碎片",cRate:993},{name:"Sacrifice_at_Midnight",cName:"午夜的奉獻碎片",cRate:994},{name:"Mortal_Rage",cName:"凡人的憤怒碎片",cRate:995},{name:"Mortal_Hope",cName:"凡人的希望碎片",cRate:996},{name:"Mortal_Ignorance",cName:"凡人的無知碎片",cRate:997},{name:"Mortal_Grief",cName:"凡人的哀傷碎片",cRate:998}];$scope.selectedCurrencyA=$scope.currencyList[9];$scope.currencyAmountA=1;$scope.selectedCurrencyB=$scope.currencyList[1];$scope.currencyAmountB=20;$scope.hugeAmount=false;$scope.ign="";$scope.myOffers=[];$scope.theirOffers=[];$scope.addAndSearch=function(){if($scope.myOffers.length>=5){swal({title:"達到上限",text:"目前測試版掛賣上限為5個，但你仍可透過此功能進行搜尋。",type:"error",confirmButtonText:"不再提醒"})}else{io.socket.request("/wish/new",{type:"c2c",fromItem:$scope.selectedCurrencyA.name,toItem:$scope.selectedCurrencyB.name,fromQuantity:$scope.currencyAmountA,toQuantity:$scope.currencyAmountB,hugeAmount:$scope.hugeAmount},function(data){if(!!data.err){console.log(data.err);return swal({title:"伺服器出錯",text:"請回報至粉絲專頁: https://www.facebook.com/poetool",type:"error",confirmButtonText:"OK"})}else{$scope.myOffers.push(data.created);console.log(data.created);return $scope.$apply()}})}return $scope.offerSearch($scope.selectedCurrencyB.name,$scope.selectedCurrencyA.name)};$scope.searchOnly=function(){return $scope.offerSearch($scope.selectedCurrencyB.name,$scope.selectedCurrencyA.name)};$scope.offerSearch=function(fromItem,toItem){return io.socket.request("/wish/get",{type:"c2c",fromItem:fromItem,toItem:toItem},function(data){if(!!data.err){console.log(data.err);return swal({title:"伺服器出錯",text:"請回報至粉絲專頁: https://www.facebook.com/poetool",type:"error",confirmButtonText:"OK"})}else{$scope.theirOffers=data.found;console.log(data.found);return $scope.$apply()}})};$scope.offerDelete=function(id){return io.socket.request("/wish/delete",{id:id},function(data){var i$,ref$,len$,index,offer;if(!!data.err){return console.log(data.err)}else{for(i$=0,len$=(ref$=$scope.myOffers).length;i$<len$;++i$){index=i$;offer=ref$[i$];if(offer.id===id){$scope.myOffers.splice(index,1);break}}return $scope.$apply()}})};$scope.offerTrade=function(offer){offer.offerSent=true;offer.status="邀請發送中";return io.socket.request("/wish/trade",{id:offer.id},function(data){if(!!data.err){return console.log(data.err)}else{offer.status="邀請已發送";return $scope.$apply()}})};$scope.offerInvited=function(message){var i$,ref$,len$,index,offer,results$=[];for(i$=0,len$=(ref$=$scope.myOffers).length;i$<len$;++i$){index=i$;offer=ref$[i$];if(offer.id===message.id){swal({title:'<span class="offerQuantityBig">'+offer.fromQuantity+'x</span><img class="swalOfferImage" src="img/currency/78px/'+offer.fromItem+'.png" /><span class="offerQuantityBig">&gt;</span><span class="offerQuantityBig">'+offer.toQuantity+'x</span><img class="swalOfferImage" src="img/currency/78px/'+offer.toItem+'.png" />',text:"有人接受了您的出價並邀請進行交易，要將角色名稱交給對方嗎？",showCancelButton:true,confirmButtonText:"立即交易",cancelButtonText:"取消",closeOnConfirm:false},fn$);break}}return results$;function fn$(isConfirm){if(isConfirm){return io.socket.request("/wish/tradeAccept",{id:offer.id,ign:$scope.ign,toUser:message.toUser,closed:false},function(data){if(!!data.err){return console.log(data.err)}else{return swal("角色名稱已送出","現在您只需回到遊戲等待對方聯絡","success")}})}}};$scope.offerAccepted=function(message){var i$,ref$,len$,index,offer,results$=[];for(i$=0,len$=(ref$=$scope.theirOffers).length;i$<len$;++i$){index=i$;offer=ref$[i$];if(offer.id===message.id){offer.status="立即於遊戲貼上: @"+message.ign+" 您好，我剛在POE工具箱邀請以"+offer.toQuantity+"x"+$scope.eng2chi(offer.toItem)+"向你交換"+offer.fromQuantity+"x"+$scope.eng2chi(offer.fromItem);$scope.$apply();break}}return results$};return $scope.eng2chi=function(eng){var i$,ref$,len$,i;for(i$=0,len$=(ref$=$scope.currencyList).length;i$<len$;++i$){i=ref$[i$];if(i.name===eng){return i.cName}}}})}).call(this);